<?phpnamespace App\AdminModule\Presenters\Forms\Oznam;use Nette\Application\UI\Form;use DbTable;use Nette\Security\User;use Nette\Utils\Html;use Nette\Utils\Random;/** * Komponenta pre vypísanie a spracovanie formulara oznamov.  *  * Posledna zmena(last change): 21.06.2017 * * @author Ing. Peter VOJTECH ml. <petak23@gmail.com>  * @copyright Copyright (c) 2012 - 2017 Ing. Peter VOJTECH ml. * @license * @link http://petak23.echo-msz.eu * @version 1.0.4 */class EditOznamFormFactory {  /** @var DbTable\Oznam */	private $oznam;  /** @var array Urovne registracie */  public $urovneReg;  /** @var DbTable\Ikonka */  public $ikonka;  /**   * @param DbTable\Oznam $oznam   * @param DbTable\User_roles $user_roles   * @param DbTable\Ikonka $ikonka   * @param User $user */  public function __construct(DbTable\Oznam $oznam, DbTable\User_roles $user_roles, DbTable\Ikonka $ikonka, User $user) {		$this->oznam = $oznam;    $this->ikonka = $ikonka;    $this->urovneReg = $user_roles->urovneReg(($user->isLoggedIn()) ? $user->getIdentity()->id_user_roles : 0);	}    /**   * Formular pre editaciu a pridanie oznamu   * @param int $oznam_ucast Povolenie potvrdenia ucasti   * @param boolean $oznam_title_image_en Povolenie titulneho obrazka   * @param string $nazov_stranky Nazov stranky   * @return Form */  public function create($oznam_ucast, $oznam_title_image_en, $nazov_stranky) {    $form = new Form();		$form->addProtection();    $form->addHidden("id");$form->addHidden("id_user_main");$form->addHidden("datum_zadania");		$form->addDatePicker('datum_platnosti', 'Dátum platnosti')				 ->addRule(Form::FILLED, 'Dátum platnosti musí byť zadaný!');		$form->addText('nazov', 'Nadpis:', 50, 80)				 ->addRule(Form::MIN_LENGTH, 'Nadpis musí mať spoň %d znakov!', 3)				 ->setRequired('Názov musí byť zadaný!');		$form->addSelect('id_user_roles', 'Povolené prezeranie pre min. úroveň:', $this->urovneReg);		if ($oznam_ucast) { $form->addCheckbox('potvrdenie', ' Potvrdenie účasti'); }     if (!$oznam_title_image_en) {       $ikonky = $this->ikonka->findAll()->fetchPairs('id', 'nazov');      $outDir = 'http://'.$nazov_stranky.'/www/ikonky/64/';      foreach ($ikonky as $key => $nazov) {        $iko[$key] = Html::el('img', ['class'=>'ikonkySmall'])->src($outDir.$nazov.'_64.png');      }      $form->addRadiolist('id_ikonka', 'Ikonka pred článkom:', $iko)           ->setAttribute('class', 'ikons-set')           ->getSeparatorPrototype()->setName(NULL);    }		$form->addTextArea('text', 'Text:')				 ->setAttribute('cols', 60)->setAttribute('class', 'jquery_ckeditor');    $form->addSubmit('uloz', 'Ulož')         ->setAttribute('class', 'btn btn-success')         ->onClick[] = [$this, 'editOznamFormSubmitted'];    $form->addSubmit('cancel', 'Cancel')->setAttribute('class', 'btn btn-default')         ->setValidationScope(FALSE);		return $form;	}    /**    * Spracovanie vstupov z formulara   * @param Nette\Forms\Controls\SubmitButton $button Data formulara */	public function editOznamFormSubmitted($button)	{    $values = $button->getForm()->getValues();    try {      if (($oznam = $this->oznam->ulozOznam($values)) !== FALSE && $oznam->oznam_kluc == null) { //Priradenie kluca k oznamu        $oznam->update(['oznam_kluc'=>Random::generate()]); //Vygeneruje nahodny retazec dlzky 10 znakov      }      $values->offsetSet('id', $oznam->id); //Aby som ho mohol neskor pouzit		} catch (Database\DriverException $e) {			$button->addError($e->getMessage());		}	}}